name: migraphx

on: [push]

env:
  DOCKER_USER: ${{secrets.DOCKERHUB_USERID}}
  DOCKER_PASSWORD: ${{secrets.DOCKERHUB_PASSWORD}}

jobs:
  cancel:
    runs-on: ubuntu-latest
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
        with:
          access_token: ${{ github.token }}

  check_image:
    name: Check if image exists in registry
    runs-on: ubuntu-latest
    outputs:
      imageexists:  ${{ steps.check_image.outputs.imageexists }}
      imagetag:  ${{ steps.image_hash.outputs.imagetag }}

    steps: 
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create Image Tag
        id: image_hash
        run: |
          echo "imagetag=${{hashFiles('**/hip-clang.docker')}}" >> $GITHUB_OUTPUT

      - name: Check if image is built already
        id: check_image
        env:
          TAGHASH: ${{ steps.image_hash.outputs.imagetag }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USER --password-stdin

          if [[ "$(docker manifest inspect rocm/migraphx-private:hip-clang-${{ env.TAGHASH }} 2> /dev/null)" == "" ]]; then
            echo "imageexists=true" >> $GITHUB_OUTPUT
          fi

  build_image:
    name: Build image
    runs-on: ubuntu-latest
    needs: check_image
    if: ${{ needs.check_image.outputs.imageexists == 'true' }}
    steps:
    - uses: actions/checkout@v3

    - name: check image list
      run: |
        docker image ls

    - name: check File System Size
      run: |
        df -h

    - name: Free space
      uses: jlumbroso/free-disk-space@main
      continue-on-error: true
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true
        docker-images: true
      
    - name: check File System Size
      run: df -h

    - name: Docker prep
      run: |
        echo $TAGHASH
        echo ${{ env.TAGHASH }}
        echo $DOCKER_PASSWORD | docker login -u $DOCKER_USER --password-stdin
        docker build . --file hip-clang.docker --tag rocm/migraphx-private:hip-clang-${{ env.TAGHASH }};
        docker push rocm/migraphx-private:hip-clang-${{ env.TAGHASH }};

    - name: check File System Size
      run: |
        df -h
        docker image ls

  run_test:
    runs-on: ubuntu-latest
    needs: build_image
    if: always() && (needs.build_image.result == 'success' || (needs.build_image.result == 'skipped')
    steps:
    - uses: actions/checkout@v3

    - name: check File System Size
      run: df -h

    - name: Free space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        swap-storage: true
        docker-images: true

    - name: check File System Size
      run: |
        du -h --max-depth=2 /usr/local
        df -h
        docker image ls

    - name: Pull Docker
      run:  |
        echo $DOCKER_PASSWORD | docker login -u $DOCKER_USER --password-stdin
        docker pull rocm/migraphx-private:hip-clang-${{hashFiles('**/hip-clang.docker')}} 
        docker tag rocm/migraphx-private:hip-clang-${{hashFiles('**/hip-clang.docker')}} migraphx:latest

    - name: check image list
      run: docker image ls

    - name: check File System Size
      run: df -h

    - name: Load Docker image
      shell: bash -c "docker run -i -v=$GITHUB_WORKSPACE:/data -w /data migraphx bash < {0}"
      run: |
        ls -l /opt 

